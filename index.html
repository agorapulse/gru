<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Gru - HTTP Testing Framework</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="css/gru.css?v={version}" />
<style>
.hidden {
    display: none;
}

.switch {
    border-width: 1px 1px 0 1px;
    border-style: solid;
    border-color: #7a2518;
    display: inline-block;
}

.switch--item {
    padding: 10px;
    background-color: #ffffff;
    color: #7a2518;
    display: inline-block;
    cursor: pointer;
}

.switch--item.selected {
    background-color: #7a2519;
    color: #ffffff;
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
    $('.primary').each(function() {
        primary = $(this);
        createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
        primary.children('.title').remove();
    });
    $('.secondary').each(function(idx, node) {
        secondary = $(node);
        primary = findPrimary(secondary);
        switchItem = createSwitchItem(secondary, primary.children('.switch'));
        switchItem.content.addClass('hidden');
        findPrimary(secondary).append(switchItem.content);
        secondary.remove();
    });
}

function createBlockSwitch(primary) {
    blockSwitch = $('<div class="switch"></div>');
    primary.prepend(blockSwitch);
    return blockSwitch;
}

function findPrimary(secondary) {
    candidate = secondary.prev();
    while (!candidate.is('.primary')) {
        candidate = candidate.prev();
    }
    return candidate;
}

function createSwitchItem(block, blockSwitch) {
    blockName = block.children('.title').text();
    content = block.children('.content').first().append(block.next('.colist'));
    item = $('<div class="switch--item">' + blockName + '</div>');
    item.on('click', '', content, function(e) {
        $(this).addClass('selected');
        $(this).siblings().removeClass('selected');
        e.data.siblings('.content').addClass('hidden');
        e.data.removeClass('hidden');
    });
    blockSwitch.append(item);
    return {'item': item, 'content': content};
}

$(addBlockSwitches);

</script>

</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Gru - HTTP Testing Framework</h1>
<div class="details">
<span id="revnumber">version 2.0.2</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_installation">1. Installation</a></li>
<li><a href="#_setup">2. Setup</a>
<ul class="sectlevel2">
<li><a href="#_http">2.1. HTTP</a></li>
<li><a href="#_micronaut">2.2. Micronaut</a></li>
<li><a href="#_grails">2.3. Grails</a></li>
<li><a href="#_spring">2.4. Spring</a></li>
</ul>
</li>
<li><a href="#_common_interactions">3. Common Interactions</a>
<ul class="sectlevel2">
<li><a href="#_request">3.1. Request</a>
<ul class="sectlevel3">
<li><a href="#_url_parameters">3.1.1. URL Parameters</a></li>
<li><a href="#_request_headers">3.1.2. Request Headers</a></li>
<li><a href="#json-payload">3.1.3. JSON Payload</a></li>
<li><a href="#generic-payload">3.1.4. Generic Payload</a></li>
<li><a href="#file-upload">3.1.5. File Upload</a></li>
<li><a href="#cookies">3.1.6. Cookies</a></li>
</ul>
</li>
<li><a href="#_response">3.2. Response</a>
<ul class="sectlevel3">
<li><a href="#_status_code">3.2.1. Status Code</a></li>
<li><a href="#_response_headers">3.2.2. Response Headers</a></li>
<li><a href="#redirect">3.2.3. Redirection</a></li>
<li><a href="#_plain_text_response">3.2.4. Plain Text Response</a></li>
<li><a href="#_json_response">3.2.5. JSON Response</a></li>
<li><a href="#_html_response">3.2.6. HTML Response</a></li>
<li><a href="#_capturing_text_response">3.2.7. Capturing Text Response</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_grails_unit_test_interactions">4. Grails Unit Test Interactions</a>
<ul class="sectlevel2">
<li><a href="#_artifacts">4.1. Artifacts</a>
<ul class="sectlevel3">
<li><a href="#_url_mappings">4.1.1. URL Mappings</a></li>
<li><a href="#_interceptors">4.1.2. Interceptors</a></li>
</ul>
</li>
<li><a href="#_request_2">4.2. Request</a>
<ul class="sectlevel3">
<li><a href="#_controller_action">4.2.1. Controller Action</a></li>
</ul>
</li>
<li><a href="#_response_2">4.3. Response</a>
<ul class="sectlevel3">
<li><a href="#_forwarding">4.3.1. Forwarding</a></li>
<li><a href="#_model">4.3.2. Model</a></li>
</ul>
</li>
<li><a href="#_integration_tests">4.4. Integration Tests</a></li>
</ul>
</li>
<li><a href="#_spring_unit_test_integration">5. Spring Unit Test Integration</a>
<ul class="sectlevel2">
<li><a href="#_mockmvc_builders">5.1. MockMVC Builders</a></li>
<li><a href="#_integration_tests_2">5.2. Integration Tests</a></li>
</ul>
</li>
<li><a href="#_aws_api_gateway">6. AWS API Gateway</a></li>
<li><a href="#_extending_gru">7. Extending Gru</a>
<ul class="sectlevel2">
<li><a href="#_extending_dsl">7.1. Extending DSL</a></li>
<li><a href="#_creating_new_client">7.2. Creating New Client</a></li>
</ul>
</li>
<li><a href="#_release_notes">8. Release Notes</a>
<ul class="sectlevel2">
<li><a href="#_2_0_0">8.1. 2.0.0</a>
<ul class="sectlevel3">
<li><a href="#_breaking_changes">8.1.1. Breaking Changes</a></li>
<li><a href="#_new_features">8.1.2. New Features</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock ribbon">
<div class="content">
<a class="image" href="https://github.com/agorapulse/gru"><img src="images/ribbon.png" alt="ribbon"></a>
</div>
</div>
<div class="paragraph">
<p>Gru is HTTP interaction testing framework with out-of-box support for Micronaut, Grails, Spring MVC, API Gateway, but it can be used with any HTTP server.</p>
</div>
<div class="paragraph">
<p>Gru is based on snapshot testing of the payloads. It excels in testing JSON response by leveraging <a href="https://github.com/lukas-krecan/JsonUnit">JsonUnit</a> placeholders to substitute dynamic values such as timestamps or random IDs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation"><a class="anchor" href="#_installation"></a>1. Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Gru is available in Maven Central. You can use any combination of the following libraries you need.</p>
</div>
<div class="listingblock">
<div class="title">Gradle Installation</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">repositories {
    mavenCentral()
}

dependencies {
    testImplementation platform("com.agorapulse:gru-bom:2.0.2")             <i class="conum" data-value="1"></i><b>(1)</b>

    // the basic dependency including the generic HTTP client
    testImplementation("com.agorapulse:gru")                                            <i class="conum" data-value="2"></i><b>(2)</b>

    // pick any of these as you need, see the bullet points below for more details
    testImplementation("com.agorapulse:gru-kotlin")                                     <i class="conum" data-value="3"></i><b>(3)</b>
    testImplementation("com.agorapulse:gru-micronaut")                                  <i class="conum" data-value="4"></i><b>(4)</b>
    testImplementation("com.agorapulse:gru-spring")                                     <i class="conum" data-value="5"></i><b>(5)</b>
    testImplementation("com.agorapulse:gru-spring-integration-testing")                 <i class="conum" data-value="6"></i><b>(6)</b>
    testImplementation("com.agorapulse:gru-grails")                                     <i class="conum" data-value="7"></i><b>(7)</b>
    testImplementation("com.agorapulse:gru-api-gateway")                                <i class="conum" data-value="8"></i><b>(8)</b>
    testImplementation("com.agorapulse:gru-okhttp")                                     <i class="conum" data-value="9"></i><b>(9)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can use BOM to manage the dependencies, otherwise include the version number with each dependency</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The basic module including the generic HTTP client</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Kotlin module for Kotlin DSL</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Micronaut module for running HTTP request against the embedded server</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Spring module to emulate HTTP interaction using <code>MockMvc</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Spring module for real HTTP calls in integration tests</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Grails module to emulate HTTP interaction within Grails Unit tests</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>AWS API Gateway module for HTTP proxy lambdas</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Alternative OkHttp module for real HTTP calls in integration tests</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup"><a class="anchor" href="#_setup"></a>2. Setup</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_http"><a class="anchor" href="#_http"></a>2.1. HTTP</h3>
<div class="paragraph">
<p>Gru can be used to test any HTTP endpoint, including Micronaut applications running on embedded server or
Grails application running within integration tests.</p>
</div>
<div class="listingblock primary">
<div class="title">Minimal HTTP Usage (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package heist;

import com.agorapulse.gru.Gru;
import com.agorapulse.gru.http.Http;
import org.junit.Test;

public class HttpTest {

    Gru gru = Gru.create("https://despicableme.fandom.com");                            <i class="conum" data-value="1"></i><b>(1)</b>

    @Test
    public void testGetWiki() throws Throwable {
        gru.verify(test -&gt; test.get("/wiki/Felonius_Gru"));                             <i class="conum" data-value="2"></i><b>(2)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Gru</code> initialized with the base URL <code><a href="http://despicableme.wikia.com" class="bare">http://despicableme.wikia.com</a></code> for HTTP calls</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execute HTTP GET request on <code>/wiki/Felonius_Gru</code> URI and verify it is accessible and returns <code>OK(200)</code> status code.</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Minimal HTTP Usage (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">package heist.kt

import com.agorapulse.gru.kotlin.create

import io.kotest.core.spec.style.StringSpec

class HttpTest : StringSpec({

    "minimal Gru test" {
        val gru = create("https://despicableme.fandom.com")                             <i class="conum" data-value="1"></i><b>(1)</b>
        gru.verify {
            get("/wiki/Felonius_Gru")                                                   <i class="conum" data-value="2"></i><b>(2)</b>
        }
    }

})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Gru</code> initialized with the base URL <code><a href="http://despicableme.wikia.com" class="bare">http://despicableme.wikia.com</a></code> for HTTP calls</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execute HTTP GET request on <code>/wiki/Felonius_Gru</code> URI and verify it is accessible and returns <code>OK(200)</code> status code.</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Minimal HTTP Usage (groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package heist

import com.agorapulse.gru.Gru
import spock.lang.Specification

class HttpSpec extends Specification{

    Gru gru = Gru.create('https://despicableme.fandom.com')                             <i class="conum" data-value="1"></i><b>(1)</b>

    void 'despicable me'() {
        expect:
            gru.test {
                get "/wiki/Felonius_Gru"                                                <i class="conum" data-value="2"></i><b>(2)</b>
            }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Gru</code> initialized with the base URL <code><a href="http://despicableme.wikia.com" class="bare">http://despicableme.wikia.com</a></code> for HTTP calls</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execute HTTP GET request on <code>/wiki/Felonius_Gru</code> URI and verify it is accessible and returns <code>OK(200)</code> status code.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The timeouts are automatically increased to one hour when debug mode is detected.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_micronaut"><a class="anchor" href="#_micronaut"></a>2.2. Micronaut</h3>
<div class="paragraph">
<p>Micronaut plays well with <code>@MicronautTest</code> annotation. If you are using <code>@MicronautTest</code> you can simply inject
<code>Gru</code> instance into your test.</p>
</div>
<div class="listingblock primary">
<div class="title">Using @Inject (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package heist;

import com.agorapulse.gru.Gru;
import io.micronaut.test.extensions.junit5.annotation.MicronautTest;
import org.junit.jupiter.api.Test;

import jakarta.inject.Inject;

@MicronautTest                                                                          <i class="conum" data-value="1"></i><b>(1)</b>
public class InjectNativeMicronautTest {

    @Inject Gru gru;                                                                    <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    public void testGet() throws Throwable {
        gru.verify(test -&gt; test
            .get("/moons/earth/moon")
            .expect(response -&gt; response.json("moon.json"))
        );
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate your test with <code>@MicronautTest</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject <code>Gru</code></td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Using @Inject (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">package heist.kt

import com.agorapulse.gru.kotlin.Gru
import io.kotest.core.spec.style.StringSpec
import io.micronaut.test.extensions.kotest5.annotation.MicronautTest

@MicronautTest                                                                          <i class="conum" data-value="1"></i><b>(1)</b>
class InjectNativeMicronautSpec(private val gru: Gru) : StringSpec({                    <i class="conum" data-value="2"></i><b>(2)</b>

    "test it works" {
        gru.verify {
            get("/moons/earth/moon")
            expect {
                json("moon.json")
            }
        }
    }

})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate your test with <code>@MicronautTest</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject <code>Gru</code></td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Using @Inject (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package heist

import com.agorapulse.gru.Gru
import io.micronaut.test.extensions.spock.annotation.MicronautTest
import spock.lang.Specification

import jakarta.inject.Inject

@MicronautTest                                                                          <i class="conum" data-value="1"></i><b>(1)</b>
class InjectNativeMicronautSpec extends Specification {

    @Inject Gru gru                                                                     <i class="conum" data-value="2"></i><b>(2)</b>

    void 'test it works'() {
        expect:
            gru.test {
                get '/moons/earth/moon'
                expect {
                    json 'moon.json'
                }
            }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate your test with <code>@MicronautTest</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject <code>Gru</code></td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
By default, the HTTP client uses Micronaut&#8217;s <code>HttpClient</code> but you can switch to different implementation by setting the property <code>gru.http.client</code> to <code>okhttp</code> or <code>jdk</code>. Using <code>OkHttp</code> client requires adding <code>gru-okhttp</code> library to the classpath. If you want to provide your own client implementation, you can implement <code>Client</code> interface and register it as a <code>@Primary</code> bean.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, you can let <code>Gru</code> to create default <code>ApplicationContext</code> for you.</p>
</div>
<div class="listingblock primary">
<div class="title">Default Application Context (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package heist;

import com.agorapulse.gru.Gru;
import com.agorapulse.gru.micronaut.Micronaut;
import io.micronaut.context.env.Environment;
import org.junit.jupiter.api.Test;

import jakarta.inject.Inject;

import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

public class AutomaticMicronautTest {

    Gru gru = Gru.create(Micronaut.create(this));                                       <i class="conum" data-value="1"></i><b>(1)</b>

    @Inject Environment environment;                                                    <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    public void testAutomaticContext() throws Throwable {
        assertNotNull(environment);
        assertTrue(environment.getActiveNames().contains("test"));

        gru.verify(test -&gt; test
            .get("/moons/earth/moon")
            .expect(response -&gt; response.json("moon.json"))
        );
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a simple <code>Micronaut</code> client for <code>Gru</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Default application context is created and fields can be injected into the test</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Default Application Context (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">package heist.kt

import com.agorapulse.gru.kotlin.create
import com.agorapulse.gru.micronaut.Micronaut
import io.micronaut.context.env.Environment
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Test

class AutomaticMicronautTest {

    val gru = create(Micronaut.create(this))                                            <i class="conum" data-value="1"></i><b>(1)</b>

    @Inject
    lateinit var environment: Environment                                               <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    fun basicTest() {
        assertTrue(environment.activeNames.contains("test"))

        gru.verify {
            get("/moons/earth/moon")
            expect {
                json("moon.json")
            }
        }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a simple <code>Micronaut</code> client for <code>Gru</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Default application context is created and fields can be injected into the test</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Default Application Context (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package heist

import com.agorapulse.gru.Gru
import com.agorapulse.gru.micronaut.Micronaut
import io.micronaut.context.env.Environment
import spock.lang.Specification

import jakarta.inject.Inject

class AutomaticMicronautSpec extends Specification {

    Gru gru = Gru.create(Micronaut.create(this))                                        <i class="conum" data-value="1"></i><b>(1)</b>

    @Inject Environment environment                                                     <i class="conum" data-value="2"></i><b>(2)</b>

    void 'test it works'() {
        expect:
            'test' in environment.activeNames
        and:
            gru.test {
                get '/moons/earth/moon'
                expect {
                    json 'moon.json'
                }
            }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a simple <code>Micronaut</code> client for <code>Gru</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Default application context is created and fields can be injected into the test</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you construct the application context yourself then you need to point <code>Gru</code> to the field of type <code>ApplicationContext</code>.</p>
</div>
<div class="listingblock primary">
<div class="title">Custom Application Context (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package heist;

import com.agorapulse.gru.Gru;
import com.agorapulse.gru.micronaut.Micronaut;
import io.micronaut.context.ApplicationContext;
import io.micronaut.runtime.server.EmbeddedServer;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

class ManualWithSimpleProviderMicronautTest {

    private Gru gru = Gru.create(Micronaut.create(this, this::getContext));             <i class="conum" data-value="1"></i><b>(1)</b>

    private ApplicationContext context;
    private EmbeddedServer embeddedServer;

    @BeforeEach
    public void setup() {
        context = ApplicationContext.builder().build();
        context.start();

        embeddedServer = context.getBean(EmbeddedServer.class);
        embeddedServer.start();
    }

    @AfterEach
    public void cleanUp() {
        embeddedServer.close();
        context.close();
    }


    @Test
    public void testMoon() throws Throwable {
        gru.verify(test -&gt; test
            .get("/moons/earth/moon")
            .expect(response -&gt; response.json("moon.json"))
        );
    }

    private ApplicationContext getContext() {
        return context;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Point <code>Gru</code> to field <code>context</code> holding the custom <code>ApplicationContext</code> instance</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Custom Application Context (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">package heist.kt

import com.agorapulse.gru.kotlin.create
import com.agorapulse.gru.micronaut.Micronaut
import io.micronaut.context.ApplicationContext
import io.micronaut.runtime.server.EmbeddedServer
import org.junit.jupiter.api.AfterEach
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test

class ManualWithSimpleProviderMicronautTest {

    private val gru = create(Micronaut.create(this) { context })                        <i class="conum" data-value="1"></i><b>(1)</b>

    private lateinit var context: ApplicationContext
    private lateinit var embeddedServer: EmbeddedServer

    @BeforeEach
    fun setup() {
        context = ApplicationContext.builder().build()
        context.start()

        embeddedServer = context.getBean(EmbeddedServer::class.java)
        embeddedServer.start()
    }

    @AfterEach
    fun cleanUp() {
        embeddedServer.close()
        context.close()
    }


    @Test
    fun testMoon() {
        gru.verify {
            get("/moons/earth/moon")
            expect {
                json("moon.json")
            }
        }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Point <code>Gru</code> to field <code>context</code> holding the custom <code>ApplicationContext</code> instance</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Custom Application Context (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package heist

import com.agorapulse.gru.Gru
import com.agorapulse.gru.micronaut.Micronaut
import io.micronaut.context.ApplicationContext
import io.micronaut.runtime.server.EmbeddedServer
import spock.lang.AutoCleanup
import spock.lang.Specification

class ManualWithSimpleProviderMicronautSpec extends Specification {

    Gru gru = Gru.create(Micronaut.create(this) { context })                            <i class="conum" data-value="1"></i><b>(1)</b>

    @AutoCleanup ApplicationContext context
    @AutoCleanup EmbeddedServer embeddedServer

    void setup() {
        context = ApplicationContext.builder().build()
        context.start()

        embeddedServer = context.getBean(EmbeddedServer)
        embeddedServer.start()
    }

    void 'test it works'() {
        expect:
            gru.test {
                get '/moons/earth/moon'
                expect {
                    json 'moon.json'
                }
            }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Point <code>Gru</code> to field <code>context</code> holding the custom <code>ApplicationContext</code> instance</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As an alternative, you can make your test class implement <code>io.micronaut.context.ApplicationContextProvider</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Gru can actually help you create the custom context:</p>
</div>
<div class="listingblock primary">
<div class="title">Custom Application Context (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package heist;

import com.agorapulse.gru.Gru;
import com.agorapulse.gru.micronaut.Micronaut;
import heist.micronaut.Moon;
import heist.micronaut.MoonService;
import io.micronaut.context.env.Environment;
import org.junit.jupiter.api.Test;

import jakarta.inject.Inject;

import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.Mockito.*;

public class AdvancedAutomaticMicronautTest {

    private MoonService moonService = mock(MoonService.class);                          <i class="conum" data-value="1"></i><b>(1)</b>

    private Gru gru = Gru.create(
        Micronaut.build(this)
            .doWithContextBuilder(b -&gt;
                b.environments("my-custom-env")                                         <i class="conum" data-value="2"></i><b>(2)</b>
            ).doWithContext(c -&gt;
                c.registerSingleton(MoonService.class, moonService)                     <i class="conum" data-value="3"></i><b>(3)</b>
            ).start()                                                                   <i class="conum" data-value="4"></i><b>(4)</b>
    );

    @Inject
    private Environment environment;                                                    <i class="conum" data-value="5"></i><b>(5)</b>

    @Test
    public void testMoon() throws Throwable {
        assertNotNull(environment);

        assertTrue(environment.getActiveNames().contains("test"));
        assertTrue(environment.getActiveNames().contains("my-custom-env"));

        when(moonService.get("earth", "moon")).thenReturn(new Moon("earth", "moon"));

        gru.verify(test -&gt; test
            .get("/moons/earth/moon")
            .expect(response -&gt; response.json("moon.json"))
        );

        verify(moonService, times(1)).get("earth", "moon");
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare any field you want to reference from the context before <code>Gru</code> declaration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Customize the <code>ApplicationContextBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Customize the <code>ApplicationContext</code> itself, e.g. register mocks</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start the application and injects fields into the test automatically</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The field can be automatically injected</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Custom Application Context (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">package heist.kt

import com.agorapulse.gru.kotlin.create
import com.agorapulse.gru.micronaut.Micronaut
import heist.micronaut.Moon
import heist.micronaut.MoonService
import io.micronaut.context.env.Environment
import jakarta.inject.Inject
import org.junit.jupiter.api.Test

import org.junit.jupiter.api.Assertions.assertNotNull
import org.junit.jupiter.api.Assertions.assertTrue
import org.mockito.Mockito.*

class AdvancedAutomaticMicronautTest {

    private val moonService = mock(MoonService::class.java)                             <i class="conum" data-value="1"></i><b>(1)</b>

    private val gru = create(
        Micronaut.build(this)
            .doWithContextBuilder { b -&gt;
                b.environments("my-custom-env")                                         <i class="conum" data-value="2"></i><b>(2)</b>
            }.doWithContext { c -&gt;
                c.registerSingleton(MoonService::class.java, moonService)               <i class="conum" data-value="3"></i><b>(3)</b>
            }.start()                                                                   <i class="conum" data-value="4"></i><b>(4)</b>
    )

    @Inject
    private lateinit var environment: Environment                                       <i class="conum" data-value="5"></i><b>(5)</b>

    @Test
    fun testMoon() {
        assertNotNull(environment)

        assertTrue(environment.activeNames.contains("test"))
        assertTrue(environment.activeNames.contains("my-custom-env"))

        `when`(moonService.get("earth", "moon")).thenReturn(Moon("earth", "moon"))

        gru.verify {
            get("/moons/earth/moon")
            expect {
                json("moon.json")
            }
        }

        verify(moonService, times(1)).get("earth", "moon")
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare any field you want to reference from the context before <code>Gru</code> declaration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Customize the <code>ApplicationContextBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Customize the <code>ApplicationContext</code> itself, e.g. register mocks</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start the application and injects fields into the test automatically</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The field can be automatically injected</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Custom Application Context (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package heist

import com.agorapulse.gru.Gru
import com.agorapulse.gru.micronaut.Micronaut
import heist.micronaut.Moon
import heist.micronaut.MoonService
import io.micronaut.context.env.Environment
import spock.lang.Specification

import jakarta.inject.Inject

class AdvancedAutomaticMicronautSpec extends Specification {

    MoonService moonService = Mock()                                                    <i class="conum" data-value="1"></i><b>(1)</b>

    Gru gru = Gru.create(
        Micronaut.build(this) {
            environments 'my-custom-env'                                                <i class="conum" data-value="2"></i><b>(2)</b>
        }.then {
            registerSingleton(MoonService, moonService)                                 <i class="conum" data-value="3"></i><b>(3)</b>
        }.start()                                                                       <i class="conum" data-value="4"></i><b>(4)</b>
    )

    @Inject Environment environment                                                     <i class="conum" data-value="5"></i><b>(5)</b>

    void 'test it works'() {
        expect:
            'my-custom-env' in environment.activeNames
        when:
            gru.test {
                get '/moons/earth/moon'
                expect {
                    json 'moon.json'
                }
            }
        then:
            gru.verify()

            1 * moonService.get('earth', 'moon') &gt;&gt; new Moon('earth', 'moon')
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare any field you want to reference from the context before <code>Gru</code> declaration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Customize the <code>ApplicationContextBuilder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Customize the <code>ApplicationContext</code> itself, e.g. register mocks</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Start the application and injects fields into the test automatically</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The field can be automatically injected</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can further customize the creation of the underlying OkHttp client by implementing <code>MicronautGruConfiguration</code> interface.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_grails"><a class="anchor" href="#_grails"></a>2.3. Grails</h3>
<div class="paragraph">
<p>Gru for Grails tests controllers in context of other Grails artifacts such as url mappings or interceptors.
Gru steals a lot from <a href="https://testing.grails.org/latest/guide/index.html">Grails Testing Support</a>.</p>
</div>
<div id="minimal-grails-usage" class="listingblock">
<div class="title">Minimal Grails Usage</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package heist

import com.agorapulse.gru.Gru
import com.agorapulse.gru.grails.Grails
import grails.testing.web.controllers.ControllerUnitTest
import spock.lang.Specification

class BasicSpec extends Specification implements ControllerUnitTest&lt;MoonController&gt; {   <i class="conum" data-value="1"></i><b>(1)</b>

    Gru gru = Gru.create(Grails.create(this)).prepare {                                 <i class="conum" data-value="2"></i><b>(2)</b>
        include UrlMappings                                                             <i class="conum" data-value="3"></i><b>(3)</b>
    }

    void 'look at the moon'() {
        expect:
            gru.test {
                get '/moons/earth/moon'                                                 <i class="conum" data-value="4"></i><b>(4)</b>
            }
    }

    void setup() {
        controller.moonService = new MoonService()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The only requirement for Grails integration is that specification must implement <code>ControllerUnitTest</code> trait</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Gru</code> initialized with the specification object</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Include the appropriate <code>UrlMappings</code> so <code>Gru</code> knows which controller action should be executed</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>Gru</code> executes action for <code>GET</code> request to URL <code>/moons/earth/moon</code> and verifies it does not throw any exception and
it returns status <code>OK(200)</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you declare test in <code>expect</code> block then the verification happens automatically.
You can also call <code>gru.verify()</code> manually to fully leverage Spock&#8217;s power such as interaction based testing.</p>
</div>
<div class="listingblock">
<div class="title">Minimal Grails Usage with When and Then Blocks</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'look at the moon'() {
    given:
        MoonService moonService = Mock(MoonService)
        controller.moonService = moonService                                            <i class="conum" data-value="1"></i><b>(1)</b>
    when:
        gru.test {                                                                      <i class="conum" data-value="2"></i><b>(2)</b>
            get '/moons/earth/moon'
        }
    then:
        gru.verify()                                                                    <i class="conum" data-value="3"></i><b>(3)</b>
        1 * moonService.findByPlanetAndName("earth", "moon") &gt;&gt; [name: "Moon"]          <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mock the <code>moonService</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the <code>test</code> method within the <code>when</code> block</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call <code>verify</code> method manually</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Verify Spock interactions on <code>moonService</code> in <code>then</code> block</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_spring"><a class="anchor" href="#_spring"></a>2.4. Spring</h3>
<div class="paragraph">
<p>Gru for <a href="https://spring.io/">Spring</a> allows you to test your application with mocked HTTP requests. Under the hood
<a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/servlet/MockMvc.html">MockMvc</a> is used.</p>
</div>
<div class="listingblock primary">
<div class="title">Minimal Spring Usage (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package com.agorapulse.gru.spring.heist;

import com.agorapulse.gru.Gru;
import com.agorapulse.gru.spring.Spring;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.test.web.servlet.MockMvc;

@WebMvcTest                                                                             <i class="conum" data-value="1"></i><b>(1)</b>
class BasicTest {

    @Autowired MockMvc mvc;                                                             <i class="conum" data-value="2"></i><b>(2)</b>

    Gru gru = Gru.create(Spring.create(this));                                          <i class="conum" data-value="3"></i><b>(3)</b>

    @Test
    void testMoon() throws Throwable {
        gru.verify(test -&gt; test.get("/moons/earth/moon"));                              <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@WebMvcTest</code> to properly setup Spring MVC test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Field with type <code>MockMvc</code> must exist and must not be <code>null</code> during the test execution (implement <code>HasMockMvc</code> interface for faster execution)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initiate <code>Gru</code> with <code>Spring</code> client</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Issue mock <code>GET</code> request to <code>/moon/earth/moon</code> and expect it returns <code>OK(200)</code> response</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Minimal Spring Usage (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">package com.agorapulse.gru.spring.heist.kt

import com.agorapulse.gru.kotlin.create
import com.agorapulse.gru.spring.Spring
import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest
import org.springframework.test.web.servlet.MockMvc

@WebMvcTest                                                                             <i class="conum" data-value="1"></i><b>(1)</b>
class BasicTest {

    @Autowired lateinit var mvc: MockMvc                                                <i class="conum" data-value="2"></i><b>(2)</b>

    val gru = create(Spring.create(this))                                               <i class="conum" data-value="3"></i><b>(3)</b>

    @Test
    fun testMoon() {
        gru.verify { get("/moons/earth/moon") }                                         <i class="conum" data-value="4"></i><b>(4)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@WebMvcTest</code> to properly setup Spring MVC test, see the warning bellow</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Field with type <code>MockMvc</code> must exist and must not be <code>null</code> during the test execution</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initiate <code>Gru</code> with <code>Spring</code> client</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Issue mock <code>GET</code> request to <code>/moon/earth/moon</code> and expect it returns <code>OK(200)</code> response</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Minimal Spring Usage (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package com.agorapulse.gru.spring.heist

import com.agorapulse.gru.Gru
import com.agorapulse.gru.spring.Spring
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest
import org.springframework.test.web.servlet.MockMvc
import spock.lang.Specification

@WebMvcTest                                                                             <i class="conum" data-value="1"></i><b>(1)</b>
class BasicSpec extends Specification {

    @Autowired MockMvc mvc                                                              <i class="conum" data-value="2"></i><b>(2)</b>

    Gru gru = Gru.create(Spring.create(this))                                           <i class="conum" data-value="3"></i><b>(3)</b>

    void 'look at the moon'() {
        expect:
            gru.test {
                get '/moons/earth/moon'                                                 <i class="conum" data-value="4"></i><b>(4)</b>
            }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@WebMvcTest</code> to properly setup Spring MVC test, see the warning bellow</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Field with type <code>MockMvc</code> must exist and must not be <code>null</code> during the test execution</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initiate <code>Gru</code> with <code>Spring</code> client</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Issue mock <code>GET</code> request to <code>/moon/earth/moon</code> and expect it returns <code>OK(200)</code> response</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For Groovy tests, Spock version at least <code>1.1</code> must be used when executing Spring tests. For example <a href="https://projects.spring.io/spring-boot/">Spring Boot</a>
overrides the default transitive dependency back to <code>1.0</code> so you need to explicity declare Spock version in your build file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">// use the latest appropriate version, check Maven Central if you are not sure
// https://central.sonatype.com/artifact/org.spockframework/spock-core
String spockVersion = '1.1-groovy-2.4'
testImplementation("org.spockframework:spock-spring:$spockVersion")
testImplementation("org.spockframework:spock-core:$spockVersion")</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_common_interactions"><a class="anchor" href="#_common_interactions"></a>3. Common Interactions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_request"><a class="anchor" href="#_request"></a>3.1. Request</h3>
<div class="paragraph">
<p>Each Gru tests begins with HTTP request. There are methods for each of following HTTP methods:
 <code>head</code>, <code>post</code>, <code>put</code>, <code>patch</code>,
<code>delete</code>, <code>options</code>, <code>trace</code> and <code>get</code>. Each method accepts the URI to perform the request and optional request
configuration closure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Grails client requires that <code>UrlMappings</code> for given URI is specified unless the mappings are defined in <code>UrlMappings</code> class
declared in default package. See <a href="#minimal-grails-usage">Minimal Grails Usage</a> for reference.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_url_parameters"><a class="anchor" href="#_url_parameters"></a>3.1.1. URL Parameters</h4>
<div class="paragraph">
<p>You can specify additional URL parameters</p>
</div>
<div class="listingblock primary">
<div class="title">Additional URL Parameters (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void stealTheMoonWithShrinkRay() throws Throwable {
    gru.verify(test -&gt; test
        .delete("/moons/earth/moon", req -&gt; req.param("with", "shrink-ray"))
        .expect(resp -&gt; resp.status(NO_CONTENT))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Additional URL Parameters (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun stealTheMoonWithShrinkRay() {
    gru.verify {
        delete("/moons/earth/moon") {
            param("with", "shrink-ray")
        }
        expect {
            status(NO_CONTENT)
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Additional URL Parameters (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'steal the moon with shrink ray'() {
    expect:
        gru.test {
            delete '/moons/earth/moon', {
                params with: 'shrink-ray'
            }
            expect {
                status NO_CONTENT
            }
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_request_headers"><a class="anchor" href="#_request_headers"></a>3.1.2. Request Headers</h4>
<div class="paragraph">
<p>You can specify additional HTTP headers sent with the request.</p>
</div>
<div class="listingblock primary">
<div class="title">Request Headers (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void visitSecretMoonNoom() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth/noom", req -&gt; req.header("Authorization", "Felonius"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Request Headers (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun visitSecretMoonNoom() {
    gru.verify {
        get("/moons/earth/noom") {
            header("Authorization", "Felonius")
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Request Headers (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'visit secret moon Noom'() {
    expect:
        gru.test {
            get '/moons/earth/noom', {
                headers Authorization: 'Felonius'
            }
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="json-payload"><a class="anchor" href="#json-payload"></a>3.1.3. JSON Payload</h4>
<div class="paragraph">
<p>You can use JSON payload from file.</p>
</div>
<div class="listingblock primary">
<div class="title">JSON Payload (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void createMoonForMargot() throws Throwable {
    gru.verify(test -&gt; test.
        post("/moons/earth", req -&gt; req.json("newMoonRequest.json"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON Payload (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun createMoonForMargot() {
    gru.verify {
        post("/moons/earth") {
            json("newMoonRequest.json")
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON Payload (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'create moon for Margot'() {
    expect:
        gru.test {
            post '/moons/earth', {
                json 'newMoonRequest.json'
            }
        }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also define json as map or list e.g. <code>json(Collections.singletonMap("foo", "bar"))</code> in Java or  <code>json(foo: 'bar')</code> in Groovy. Both are serialized to JSON using a JSON integration on the classpath.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JSON files are loaded relatively to directory having the same name as the current specification and it is placed
in the same directory corresponding the package of the the current specification. For example if your specification name
is <code>org.example.ExampleSpec</code> then <code>createNewMoonResponse.json</code> file&#8217;s path should be <code>org/example/ExampleSpec/createNewMoonResponse.json</code>. See <a href="https://agorapulse.github.io/testing-libraries/#_fixt">Fixt</a> for more details.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Fixture JSON files are created automatically if missing. Empty object (<code>{}</code>) is created for missing request JSON file and JSON file
with the content same as the one returned from the controller is created if response file is missing but exception is thrown
so you have to run the test again and verify it is repeatable. Fixture files are generated inside directory from system property <code>TEST_RESOURCES_FOLDER</code> or
in <code>src/test/resources</code> relatively to the working directory. See the following example how to easily set the property in Gradle.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="generic-payload"><a class="anchor" href="#generic-payload"></a>3.1.4. Generic Payload</h4>
<div class="paragraph">
<p>You can use generic payload from file.</p>
</div>
<div class="listingblock primary">
<div class="title">Generic Payload (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void createMoonForMargotGeneric() throws Throwable {
    gru.verify(test -&gt; test.
        post("/moons/earth", req -&gt; req.content("newMoonRequest.json", "application/json"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Generic Payload (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun createMoonForMargotGeneric() {
    gru.verify {
        post("/moons/earth") {
            content("newMoonRequest.json", "application/json")
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Generic Payload (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'create moon for Margot generic'() {
    expect:
        gru.test {
            post '/moons/earth', {
                content 'newMoonRequest.json', 'application/json'
            }
        }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Content files are loaded relatively to directory having the same name as the current specification and it is placed
in the same directory corresponding the package of the current specification. For example if your specification name
is <code>org.example.ExampleSpec</code> then <code>createNewMoonResponse.json</code> file&#8217;s path should be <code>org/example/ExampleSpec/createNewMoonResponse.json</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Content files are created automatically if missing. Empty file is created for missing request content file.
Fixture files are generated inside directory from system property <code>TEST_RESOURCES_FOLDER</code> or
in <code>src/test/resources</code> relatively to the working directory.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="file-upload"><a class="anchor" href="#file-upload"></a>3.1.5. File Upload</h4>
<div class="paragraph">
<p>You can emulate multipart file uploads.</p>
</div>
<div class="listingblock primary">
<div class="title">Generic Payload (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void uploadFile() throws Throwable {
    gru.verify(test -&gt; test
        .post(
            "/upload",
            req -&gt; req.upload(u -&gt; u
                .param("message", "Hello")
                .file(
                    "theFile",
                    "hello.txt",
                    inline("Hello World"),
                    "text/plain"
                )
            )
        )
        .expect(resp -&gt; resp.text(inline("11")))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">File Upload (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun uploadFile() {
    gru.verify {
        post("/upload") {
            upload {                                                                <i class="conum" data-value="1"></i><b>(1)</b>
                param("message", "Hello")                                           <i class="conum" data-value="2"></i><b>(2)</b>
                file(                                                               <i class="conum" data-value="3"></i><b>(3)</b>
                    "theFile",
                    "hello.txt",
                    inline("Hello World"),
                    "text/plain"
                )
            }
        }
        expect {
            text(inline("11"))
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define upload files and parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can specify arbitrary parameter (i.g. hidden fields)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify the file to be uploaded with the name of the parameter, original filename, content and content type</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">File Upload (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'upload file with message'() {
    expect:
        gru.test {
            post '/moons/upload', {
                upload {                                                            <i class="conum" data-value="1"></i><b>(1)</b>
                    params message: 'Hello'                                         <i class="conum" data-value="2"></i><b>(2)</b>
                    file 'theFile', 'hello.txt', inline('Hello World'), 'text/plain'<i class="conum" data-value="3"></i><b>(3)</b>
                }
                // Grails only - required because of bug in mock request
                executes controller.&amp;postWithMessageAndImage                        <i class="conum" data-value="4"></i><b>(4)</b>
            }
            expect {
                json 'uploadResult.json'
            }
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define upload files and parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can specify arbitrary parameter (i.g. hidden fields)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify the file to be uploaded with the name of the parameter, original filename, content and content type</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In case of Grails unit test, you must point to the controller action&#8217;s method</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cookies"><a class="anchor" href="#cookies"></a>3.1.6. Cookies</h4>
<div class="paragraph">
<p>You can emulate cookies send by the browser or verify they have been set by the server response.</p>
</div>
<div class="listingblock primary">
<div class="title">Cookies (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void sendCookies() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/cookie", req -&gt; req.
            cookie("chocolate", "rules")                                            <i class="conum" data-value="1"></i><b>(1)</b>
        )
        .expect(resp -&gt; resp.
            json("cookies.json", Option.IGNORING_EXTRA_FIELDS)
        )
    );
}

@Test
public void setCookies() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/setCookie")
        .expect(resp -&gt; resp
            .cookie("chocolate", "rules")                                           <i class="conum" data-value="2"></i><b>(2)</b>
            .cookie(c -&gt; c                                                          <i class="conum" data-value="3"></i><b>(3)</b>
                .name("coffee")
                .value("lover")
                .secure(true)
                .domain("localhost")
            )
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Cookies (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">@Test
fun sendCookies() {
    gru.verify {
        get("/moons/cookie") {
            cookie("chocolate", "rules")                                            <i class="conum" data-value="1"></i><b>(1)</b>
        }
        expect {
            json("cookies.json", Option.IGNORING_EXTRA_FIELDS)
        }
    }
}

@Test
fun setCookies() {
    gru.verify {
        get("/moons/setCookie")
        expect {
            cookie("chocolate", "rules")                                            <i class="conum" data-value="2"></i><b>(2)</b>
            cookie {                                                                <i class="conum" data-value="3"></i><b>(3)</b>
                name("coffee")
                value("lover")
                secure(true)
                domain("localhost")
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send browser cookies</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Expect cookies sent by the server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>More detailed response cookie expectations</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Cookies (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'send cookies'() {
    expect:
        gru.test {
            get '/moons/cookie', {
                cookies chocolate: 'rules'                                          <i class="conum" data-value="1"></i><b>(1)</b>
            }
            expect {
                json 'cookies.json', IGNORING_EXTRA_FIELDS
            }
        }
}

void 'set cookies'() {
    expect:
        gru.test {
            get '/moons/setCookie'
            expect {
                cookies chocolate: 'rules'                                          <i class="conum" data-value="2"></i><b>(2)</b>
                cookie {                                                            <i class="conum" data-value="3"></i><b>(3)</b>
                    name 'coffee'
                    value 'lover'
                    secure true
                    domain 'localhost'
                }
            }
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send browser cookies</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Expect cookies sent by the server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>More detailed response cookie expectations</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_response"><a class="anchor" href="#_response"></a>3.2. Response</h3>
<div class="paragraph">
<p>Response expectation are defined using <code>expect</code> method within <code>test</code> definition.</p>
</div>
<div class="sect3">
<h4 id="_status_code"><a class="anchor" href="#_status_code"></a>3.2.1. Status Code</h4>
<div class="paragraph">
<p>You can specify expected response status code. Constants for HTTP status codes are available within the <code>expect</code> closure call.
Default status is <code>OK(200)</code> which is asserted within every test. See <a href="#redirect">Redirection</a> for exception.</p>
</div>
<div class="listingblock primary">
<div class="title">Status Code (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void stealTheMoonWithShrinkRay() throws Throwable {
    gru.verify(test -&gt; test
        .delete("/moons/earth/moon", req -&gt; req.param("with", "shrink-ray"))
        .expect(resp -&gt; resp.status(NO_CONTENT))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Status Code (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun stealTheMoonWithShrinkRay() {
    gru.verify {
        delete("/moons/earth/moon") {
            param("with", "shrink-ray")
        }
        expect {
            status(NO_CONTENT)
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Status Code (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'steal the moon with shrink ray'() {
    expect:
        gru.test {
            delete '/moons/earth/moon', {
                params with: 'shrink-ray'
            }
            expect {
                status NO_CONTENT
            }
        }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If multiple statuses are possible then you can use <code>statuses(&#8230;&#8203;)</code> method instead.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_response_headers"><a class="anchor" href="#_response_headers"></a>3.2.2. Response Headers</h4>
<div class="paragraph">
<p>You can specify expected response headers.</p>
</div>
<div class="listingblock primary">
<div class="title">Response Headers (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void jsonIsRendered() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth/moon")
        .expect(resp -&gt; resp.header("Content-Type", "application/json"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Response Headers (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun jsonIsRendered() {
    gru.verify {
        get("/moons/earth/moon")
        expect { header("Content-Type", "application/json") }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Response Headers (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'json is rendered'() {
    expect:
        gru.test {
            get '/moons/earth/moon'
            expect {
                headers 'Content-Type': 'application/json;charset=UTF-8'
            }
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="redirect"><a class="anchor" href="#redirect"></a>3.2.3. Redirection</h4>
<div class="paragraph">
<p>You can specify expected redirection URI. For redirection, default status code is <code>FOUND(302)</code>.</p>
</div>
<div class="listingblock primary">
<div class="title">Redirection (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void noPlanetNeeded() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/-/moon")
        .expect(resp -&gt; resp.redirect("/moons/earth/moon"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Redirection (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun noPlanetNeeded() {
    gru.verify {
        get("/moons/-/moon")
        expect { redirect("/moons/earth/moon") }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Redirection (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'no planet needed'() {
    expect:
        gru.test {
            get '/moons/-/moon'
            expect {
                redirect '/moons/earth/moon'
            }
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_plain_text_response"><a class="anchor" href="#_plain_text_response"></a>3.2.4. Plain Text Response</h4>
<div class="paragraph">
<p>You can specify expected plain text response. The responded JSON is verified just by <code>equals</code> method.</p>
</div>
<div class="listingblock primary">
<div class="title">Plain Text Response (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void infoIsRendered() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth/moon/info")
        .expect(resp -&gt; resp.text("textResponse.txt"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Plain Text Response (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">void 'verify text'() {
    expect:
        gru.test {
            get '/moons/earth/moon/info', {
                headers 'Accept': 'text/plain'
            }
            expect {
                text 'textResponse.txt'
            }
        }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Plain Text Response (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify text'() {
    expect:
        gru.test {
            get '/moons/earth/moon/info', {
                headers 'Accept': 'text/plain'
            }
            expect {
                text 'textResponse.txt'
            }
        }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">textResponse.txt</div>
<div class="content">
<pre>Moon goes around Earth</pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify the text inline. Inline method is also available for JSON and HTML.</p>
</div>
<div class="listingblock primary">
<div class="title">Plain Text Inline Response (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void infoIsRenderedInline() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth/moon/info")
        .expect(resp -&gt; resp.text(inline("moon goes around earth")))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Plain Text Inline Response (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun infoIsRenderedInline() {
    gru.verify {
        get("/moons/earth/moon/info")
        expect { text(inline("moon goes around earth")) }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">Plain Text Inline Response (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify text inline'() {
    expect:
        gru.test {
            get '/moons/earth/moon/info', {
                headers 'Accept': 'text/plain'
            }
            expect {
                text inline('Moon goes around Earth')
            }
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_json_response"><a class="anchor" href="#_json_response"></a>3.2.5. JSON Response</h4>
<div class="paragraph">
<p>You can specify expected JSON response. The responded JSON is verified using <a href="https://github.com/lukas-krecan/JsonUnit">JsonUnit</a>.</p>
</div>
<div class="listingblock primary">
<div class="title">JSON Response (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void verifyJson() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth/moon")
        .expect(resp -&gt; resp.json("moonResponse.json"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON Response (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun verifyJson() {
    gru.verify {
        get("/moons/earth/moon")
        expect { json("moonResponse.json") }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON Response (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify json'() {
    expect:
        gru.test {
            get '/moons/earth/moon'
            expect {
                json 'moonResponse.json'
            }
        }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">moonResponse.json</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">{
    "name": "Moon",
    "planet": "Earth",
    "created": "${json-unit.matches:isoDate}"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can pass JsonUnit options along with the file name.</p>
</div>
<div class="listingblock primary">
<div class="title">JSON Response with Options (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void verifyJsonWithOptions() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth")
        .expect(resp -&gt; resp.json("moonsResponse.json", Option.IGNORING_EXTRA_ARRAY_ITEMS))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON Response with Options (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun verifyJsonWithOptions() {
    gru.verify {
        get("/moons/earth")
        expect { json("moonsResponse.json", Option.IGNORING_EXTRA_ARRAY_ITEMS) }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JSON Response with Options (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify json 2'() {
    expect:
        gru.test {
            get '/moons/earth'
            expect {
                json 'moonsResponse.json', IGNORING_EXTRA_ARRAY_ITEMS
            }
        }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">moonsResponse.json</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="json">[
    {
        "name": "Moon",
        "planet": "Earth",
        "created": "${json-unit.matches:isoDate}"
    }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#json-payload">JSON Payload</a> for information about the expected response file location.</p>
</div>
<div class="sect4">
<h5 id="_jsonunit_primer"><a class="anchor" href="#_jsonunit_primer"></a>JsonUnit Primer</h5>
<div class="paragraph">
<p>There are built in and custom placeholders which can be used when evaluating the JSON response:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Default JsonUnit Placeholders</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Placeholder</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.ignore}"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignore content of the property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.regex}[A-Z]+"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content must match regular expression</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.any-string}"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.any-boolean}"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any boolean</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.any-number}"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any number</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Custom Gru&#8217;s Placeholders</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Placeholder</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.matches:positiveIntegerString}"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any positive number as string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.matches:isoDate}"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any date in ISO format</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.matches:isoDateNow}"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ISO within last hour</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"${json-unit.matches:url}"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any URL (string parsable by <code>java.net.URL</code>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can customize <code>JsonUnit</code> fluent assertion within <code>json</code> block inside <code>expect</code> definition:</p>
</div>
<div class="listingblock primary">
<div class="title">JsonUnit Customisation (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void customiseJsonUnit() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth/moon")
        .expect(resp -&gt; resp
            .json("moonResponse.json")
            .json(json -&gt; json
                .withTolerance(0.1)
                .withMatcher(
                    "negativeIntegerString",
                    MatchesPattern.matchesPattern("-\\d+")
                )
            )
        )
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JsonUnit Customisation (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun customiseJsonUnit() {
    gru.verify {
        get("/moons/earth/moon")
        expect {
            json("moonResponse.json")
            json {
                withTolerance(0.1)
                withMatcher(
                    "negativeIntegerString",
                    MatchesPattern.matchesPattern("-\\d+")
                )
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">JsonUnit Customisation (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'customise json unit'() {
    expect:
        gru.test {
            get '/moons/earth/moon'
            expect {
                json 'moonResponse.json'
                json {
                    withTolerance(0.1).withMatcher(
                        'negativeIntegerString',
                        MatchesPattern.matchesPattern(/-\d+/)
                    )
                }
            }
        }
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>JsonFluentAssert</code> is immutable, so only last statement actually matters. That is why <code>.withMatcher</code> is called
as method chain.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you need to rewrite your JSON fixture files then you can temporarily set the value of environment
variable <code>COM_AGORAPULSE_GRU_REWRITE</code> to <code>true</code> to let Gru rewrite all your fixtures files which are triggering assertion
errors.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>export COM_AGORAPULSE_GRU_REWRITE=true
./gradlew test
unset COM_AGORAPULSE_GRU_REWRITE</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_html_response"><a class="anchor" href="#_html_response"></a>3.2.6. HTML Response</h4>
<div class="paragraph">
<p>You can specify expected HTML response. The responded HTML is cleaned using <a href="https://jsoup.org/">jsoup</a> and
the difference is performed using <a href="http://www.xmlunit.org/">XMLUnit</a>. You can replace any text node with <code>${xml-unit.ignore}</code>
to ignore the value fo the node.</p>
</div>
<div class="listingblock primary">
<div class="title">HTML Response (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void verifyHtml() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth/moon/html")
        .expect(resp -&gt; resp.html("htmlResponse.html"))
    );
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">HTML Response (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun verifyHtml() {
    gru.verify {
        get("/moons/earth/moon/html")
        expect { html("htmlResponse.html") }
    }
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">HTML Response (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify html'() {
    expect:
        gru.test {
            get '/moons/earth/moon/info'
            expect {
                html 'htmlResponse.html'
            }
        }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">htmlResponse.html</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">&lt;html&gt;
 &lt;head&gt;
  &lt;title&gt;Moon's Info&lt;/title&gt;
  &lt;meta name="layout" content="main" /&gt;
 &lt;/head&gt;
 &lt;body&gt;
  &lt;h1&gt;Moon&lt;/h1&gt;
  &lt;h2&gt;Earth&lt;/h2&gt;
  &lt;p&gt;${xml-unit.ignore}&lt;/p&gt;
 &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
HTML support for Grails is currently experimental as it does not apply the layouts.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_capturing_text_response"><a class="anchor" href="#_capturing_text_response"></a>3.2.7. Capturing Text Response</h4>
<div class="paragraph">
<p>You can reach the response text from any content minion such as <code>JsonMinion</code> if you need
to access the actual response.</p>
</div>
<div class="listingblock primary">
<div class="title">Reading Response Text (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void testGet() throws Throwable {
    gru.test(test -&gt; test                                                           <i class="conum" data-value="1"></i><b>(1)</b>
        .get("/moons/earth/moon")
        .expect(response -&gt; response.json("moon.json"))
    );

    gru.verify();                                                                   <i class="conum" data-value="2"></i><b>(2)</b>

    String responseText = gru.getSquad()
        .ask(JsonMinion.class, AbstractContentMinion::getResponseText);             <i class="conum" data-value="3"></i><b>(3)</b>

    Assertions.assertTrue(responseText.contains("moon"));                           <i class="conum" data-value="4"></i><b>(4)</b>

    gru.close();                                                                    <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>use <code>test</code> instead of <code>verify(Consumer)</code> to keep Gru&#8217;s internal state</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>use <code>verify</code> to perform the verification call and populate the response text</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>read the response text from <code>JsonMinion</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>make some assertion using the response text</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>don&#8217;t forget to close/reset the Gru instance manually</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Reading Response Text (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun testGet() {
    gru.test {                                                                      <i class="conum" data-value="1"></i><b>(1)</b>
        get("/moons/earth/moon")
        expect { json("moon.json") }
    }

    gru.verify()                                                                    <i class="conum" data-value="2"></i><b>(2)</b>

    val responseText = gru.squad.ask&lt;JsonMinion, String&gt; {
        responseText                                                                <i class="conum" data-value="3"></i><b>(3)</b>
    }

    Assertions.assertNotNull(responseText)
    Assertions.assertTrue(responseText!!.contains("moon"))                          <i class="conum" data-value="4"></i><b>(4)</b>

    gru.close()                                                                     <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>split the verification call between <code>when</code> and <code>then</code> instead of <code>expect</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>use <code>verify</code> to perform the verification call and populate the response text</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>read the response text from <code>JsonMinion</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>make some assertion using the response text</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>don&#8217;t forget to close/reset the Gru instance manually</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Reading Response Text (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'test it works'() {
    when:                                                                           <i class="conum" data-value="1"></i><b>(1)</b>
        gru.test {
            get '/moons/earth/moon'
            expect {
                json 'moon.json'
            }
        }

    then:
        gru.verify()                                                                <i class="conum" data-value="2"></i><b>(2)</b>

    when:
        String responseText = gru.squad.ask(JsonMinion) { responseText }            <i class="conum" data-value="3"></i><b>(3)</b>
    then:
        responseText.contains('moon')                                               <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>split the verification call between <code>when</code> and <code>then</code> instead of <code>expect</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>use <code>verify</code> to perform the verification call and populate the response text</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>read the response text from <code>JsonMinion</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>make some assertion using the response text</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_grails_unit_test_interactions"><a class="anchor" href="#_grails_unit_test_interactions"></a>4. Grails Unit Test Interactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On top of standard HTTP interaction, Gru provides additional methods specific for Grails only.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of IntelliJ IDEA 2017.2 you get false warnings about the wrong method&#8217;s argument being used. You have to
ignore them at the moment. Please, vote for <a href="https://youtrack.jetbrains.com/issue/IDEA-177530">IDEA-177530</a> bug to get
this fixed soon.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_artifacts"><a class="anchor" href="#_artifacts"></a>4.1. Artifacts</h3>
<div class="paragraph">
<p>You can add additional Grails artifacts using <code>include</code> method. Only interceptors and URL mappings are supported
at the moment.</p>
</div>
<div class="sect3">
<h4 id="_url_mappings"><a class="anchor" href="#_url_mappings"></a>4.1.1. URL Mappings</h4>
<div class="paragraph">
<p>Unless you are using <code>UrlMappings</code> class in default package, you have to specify the URL mappings class used for matching
the URIs. You can use just name of the class as string if your URL mappings resides in default package.</p>
</div>
<div class="listingblock">
<div class="title">URL Mappings</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package heist

import com.agorapulse.gru.Gru
import com.agorapulse.gru.grails.Grails
import grails.testing.web.controllers.ControllerUnitTest
import spock.lang.Specification

class IncludeUrlMappingsSpec extends Specification implements ControllerUnitTest&lt;MoonController&gt; {

    Gru gru = Gru.create(Grails.create(this)).prepare {
        include ApiUrlMappings                                                          <i class="conum" data-value="1"></i><b>(1)</b>
    }

    void "moon is still there"() {
        expect:
            gru.test {
                delete '/api/v1/moons/earth/moon'                                       <i class="conum" data-value="2"></i><b>(2)</b>
                expect {
                    status BAD_REQUEST
                }
            }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Include <code>ApiUrlMappings</code> URL mappings</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The URI will be matched using <code>ApiUrlMappings</code> URL mappings</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_interceptors"><a class="anchor" href="#_interceptors"></a>4.1.2. Interceptors</h4>
<div class="paragraph">
<p>If you&#8217;re controller heavily depends on interceptor it is sometimes better to test the interceptors and controllers as
a single unit. You can include interceptors into test in similar way as url mappings using the <code>include</code> method.
Once the interceptor is included it must match the given URL otherwise exception is thrown in the verification phase.
You can add additional boolean <code>true</code> parameter to the include method to also autowire the interceptor automatically.</p>
</div>
<div class="listingblock">
<div class="title">Interceptors</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package heist

import com.agorapulse.gru.Gru
import com.agorapulse.gru.grails.Grails
import grails.testing.web.controllers.ControllerUnitTest
import spock.lang.Specification

class IncludeInterceptorSpec extends Specification implements ControllerUnitTest&lt;MoonController&gt; {

    Gru gru = Gru.create(Grails.create(this)).prepare {
        include ApiUrlMappings
        include VectorInterceptor, true                                                 <i class="conum" data-value="1"></i><b>(1)</b>
    }

    void "moon is still there"() {
        given:
            defineBeans {
                vectorMessage(VectorMessage, "Le Vecteur était là!")                    <i class="conum" data-value="2"></i><b>(2)</b>
            }
        expect:
            gru.test {
                delete '/api/v1/moons/earth/moon'
                expect {
                    status NOT_FOUND
                    headers 'X-Message': "Le Vecteur était là!"                         <i class="conum" data-value="3"></i><b>(3)</b>
                }
            }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Include <code>VectorInterceptor</code> interceptor and let it autowire the beans</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare bean which is used in the interceptor</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The expectations reflects the interceptor changes and the defined bean</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_request_2"><a class="anchor" href="#_request_2"></a>4.2. Request</h3>
<div class="sect3">
<h4 id="_controller_action"><a class="anchor" href="#_controller_action"></a>4.2.1. Controller Action</h4>
<div class="paragraph">
<p>You can verify that given URI is mapped to particular action. Use method reference with <code>.&amp;</code> to obtain
particular <code>MethodClosure</code> instance.</p>
</div>
<div class="listingblock">
<div class="title">Controller Action</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify action'() {
    expect:
        gru.test {
            get '/moons/earth/moon', {
                executes controller.&amp;moon
            }
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The test only passes if <code>/moons/earth/moon</code> URI is mapped to action <code>moon</code> in <code>MoonController</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_response_2"><a class="anchor" href="#_response_2"></a>4.3. Response</h3>
<div class="sect3">
<h4 id="_forwarding"><a class="anchor" href="#_forwarding"></a>4.3.1. Forwarding</h4>
<div class="paragraph">
<p>You can specify the expected forward URI.</p>
</div>
<div class="listingblock">
<div class="title">Model</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify forward'() {
    expect:
        gru.test {
            get '/moons/earth/moon', {
                params info: 'true'
            }
            expect {
                forward '/moons/earth/moon/info'
            }
        }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_model"><a class="anchor" href="#_model"></a>4.3.2. Model</h4>
<div class="paragraph">
<p>You can specify the expected model object returned from the controller.</p>
</div>
<div class="listingblock">
<div class="title">Model</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify model'() {
    given:
        def moon = [name: 'Moon', planet: 'Earth']
        MoonService moonService = Mock(MoonService)
        controller.moonService = moonService
    when:
        gru.test {
            get '/moons/earth/moon/info'
            expect {
                model moon: moon
            }
        }
    then:
        gru.verify()
        1 * moonService.findByPlanetAndName('earth', 'moon') &gt;&gt; moon
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_integration_tests"><a class="anchor" href="#_integration_tests"></a>4.4. Integration Tests</h3>
<div class="paragraph">
<p>You use <code>Http</code> client to verify controller within <code>@Integration</code> test.</p>
</div>
<div class="listingblock">
<div class="title">Integration Setup</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">@Value('${local.server.port}')
Integer serverPort                                                                      <i class="conum" data-value="1"></i><b>(1)</b>

Gru gru = Gru.create(Http.create(this))                                             <i class="conum" data-value="2"></i><b>(2)</b>

void setup() {
    final String serverUrl = "http://localhost:${serverPort}"                           <i class="conum" data-value="3"></i><b>(3)</b>
    gru.prepare {
        baseUri serverUrl                                                               <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Let Grails inject the server port</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>Http</code> client instad of <code>Grails</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Store server URL in variable, otherwise it won&#8217;t get properly evaluated</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the base URI for the executed test</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_unit_test_integration"><a class="anchor" href="#_spring_unit_test_integration"></a>5. Spring Unit Test Integration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On top of standard HTTP interaction, Gru provides additional methods specific for Spring only. These methods allows you
to fully leverage the power of <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/servlet/MockMvc.html">MockMvc</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of IntelliJ IDEA 2017.2 you get false warnings about the wrong method&#8217;s argument being used. You have to
ignore them at the moment. Please, vote for <a href="https://youtrack.jetbrains.com/issue/IDEA-177530">IDEA-177530</a> bug to get
this fixed soon.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_mockmvc_builders"><a class="anchor" href="#_mockmvc_builders"></a>5.1. MockMVC Builders</h3>
<div class="paragraph">
<p>You can configure additional request steps within <code>request</code> method closure definition and you can use <code>that</code>
within <code>expect</code> block to add additional <code>ResultMatcher</code>. Both methods are aliased to <code>and</code> method within their
blocks so you can write the assertions in more fluent way.</p>
</div>
<div class="listingblock primary">
<div class="title">MockMVC Builders (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@Test
public void jsonIsRendered() throws Throwable {
    gru.verify(test -&gt; test
        .get("/moons/earth/moon", req -&gt; req
            .command(RequestBuilderMinion.class, m -&gt; m                             <i class="conum" data-value="1"></i><b>(1)</b>
                .addBuildStep(mock -&gt; mock
                    .accept(MediaType.APPLICATION_JSON_UTF8)                        <i class="conum" data-value="2"></i><b>(2)</b>
                    .locale(Locale.CANADA)
                )
            )
        )
        .expect(resp -&gt; resp
            .header("Content-Type", "application/json;charset=UTF-8")
            .json("moonResponse.json")
            .command(ResultMatcherMinion.class, m -&gt; m                              <i class="conum" data-value="3"></i><b>(3)</b>
                .addMatcher(content().encoding("UTF-8"))                            <i class="conum" data-value="4"></i><b>(4)</b>
                .addMatcher(content().contentType(MediaType.APPLICATION_JSON_UTF8))
            )
        )
    );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command <code>RequestBuilderMinion</code> minion to fine-tune <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/test/web/servlet/request/MockHttpServletRequestBuilder.html">MockHttpServletRequestBuilder</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare <code>Accept</code> header</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Command <code>ResultBuilderMinion</code> minion to add additional result matchers
&lt;4&gt;&gt; Check the content encoding using the <code>content()</code> method that is statically imported from
<a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/test/web/servlet/result/MockMvcResultMatchers.html">MockMvcResultMatchers</a> class, asserts the content encoding</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">MockMVC Builders (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'json is rendered'() {
    expect:
        gru.test {
            get '/moons/earth/moon', {
                request {                                                           <i class="conum" data-value="1"></i><b>(1)</b>
                    accept(MediaType.APPLICATION_JSON_UTF8)                         <i class="conum" data-value="2"></i><b>(2)</b>
                }
                and {                                                               <i class="conum" data-value="3"></i><b>(3)</b>
                    locale(Locale.CANADA)
                }
            }
            expect {
                headers 'Content-Type': 'application/json;charset=UTF-8'
                json 'moonResponse.json'
                that content().encoding('UTF-8')                                    <i class="conum" data-value="4"></i><b>(4)</b>
                and content().contentType(MediaType.APPLICATION_JSON_UTF8)          <i class="conum" data-value="5"></i><b>(5)</b>
            }
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>request</code> method to fine-tune <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/test/web/servlet/request/MockHttpServletRequestBuilder.html">MockHttpServletRequestBuilder</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare <code>Accept</code> header</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Same as <code>request</code>, declares desired locale</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <code>that</code> method to add additional result matchers, the <code>content()</code> method is statically imported from
<a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/test/web/servlet/result/MockMvcResultMatchers.html">MockMvcResultMatchers</a> class, asserts the content encoding</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">MockMVC Builders (Kotlin)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="kotlin">@Test
fun jsonIsRendered() {
    gru.verify {
        get("/moons/earth/moon") {
            command&lt;RequestBuilderMinion&gt; {                                         <i class="conum" data-value="1"></i><b>(1)</b>
                addBuildStep { mock -&gt;
                    mock.accept(MediaType.APPLICATION_JSON_UTF8)                    <i class="conum" data-value="2"></i><b>(2)</b>
                        .locale(Locale.CANADA)
                }
            }
        }
        expect {
            header("Content-Type", "application/json;charset=UTF-8")
            json("moonResponse.json")
            command&lt;ResultMatcherMinion&gt; {                                          <i class="conum" data-value="3"></i><b>(3)</b>
                addMatcher(content().encoding("UTF-8"))                             <i class="conum" data-value="4"></i><b>(4)</b>
                addMatcher(content().contentType(MediaType.APPLICATION_JSON_UTF8))
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>request</code> method to fine-tune <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/test/web/servlet/request/MockHttpServletRequestBuilder.html">MockHttpServletRequestBuilder</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare <code>Accept</code> header</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Same as <code>request</code>, declares desired locale</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <code>that</code> method to add additional result matchers, the <code>content()</code> method is statically imported from
<a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/test/web/servlet/result/MockMvcResultMatchers.html">MockMvcResultMatchers</a> class, asserts the content encoding</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_integration_tests_2"><a class="anchor" href="#_integration_tests_2"></a>5.2. Integration Tests</h3>
<div class="paragraph">
<p>You use <code>Http</code> client to verify controller within <code>@Integration</code> test. Once <code>gru-spring-integration-test</code> is on the classpath then you can inject <code>Gru</code> bean into your tests.</p>
</div>
<div class="listingblock primary">
<div class="title">Integration Setup (Java)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">package com.agorapulse.gru.spring.heist;

import com.agorapulse.gru.Gru;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)             <i class="conum" data-value="1"></i><b>(1)</b>
public class MoonControllerIntegrationTest {

    @Autowired private Gru gru;                                                         <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    public void renderJson() throws Throwable {                                         <i class="conum" data-value="3"></i><b>(3)</b>
        gru.verify(test -&gt; test
            .get("/moons/earth/moon")
            .expect(resp -&gt; resp.json("renderJsonResponse.json"))
        );
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run integration test using the random port</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject <code>Gru</code> into your tests</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Test the application</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">Integration Setup (Groovy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package com.agorapulse.gru.spring.heist

import com.agorapulse.gru.Gru
import com.agorapulse.gru.http.Http
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.beans.factory.annotation.Value
import org.springframework.boot.test.context.SpringBootTest
import spock.lang.AutoCleanup
import spock.lang.Specification

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)             <i class="conum" data-value="1"></i><b>(1)</b>
class MoonControllerIntegrationSpec extends Specification {

    @Autowired Gru gru                                                                  <i class="conum" data-value="2"></i><b>(2)</b>

    void 'render json'() {                                                              <i class="conum" data-value="3"></i><b>(3)</b>
        expect:
            gru.test {
                get('/moons/earth/moon')
                expect {
                    json 'renderJsonResponse.json'
                }
            }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run integration test using the random port</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject <code>Gru</code> into your tests</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Test the application</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_aws_api_gateway"><a class="anchor" href="#_aws_api_gateway"></a>6. AWS API Gateway</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
AWS API Gateway itegration is currently incubating. All the basic HTTP features are implemented but custom API Proxy related
features are currently missing (e.g. customizing the API Gateway or Lambda context).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can easily test your <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/getting-started-with-lambda-integration.html">AWS API Gateway Lambda Integration</a>
with Gru. First of all you need to tell Gru which handlers are responsible for particular URLs.</p>
</div>
<div class="listingblock">
<div class="title">API Gateway Lambda Proxy Configuration</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">Gru gru = Gru.create(ApiGatewayProxy.create {
    map '/one' to SampleHandler.name                                        <i class="conum" data-value="1"></i><b>(1)</b>
    map '/two' to SampleHandler                                             <i class="conum" data-value="2"></i><b>(2)</b>
    map '/three', GET to SampleHandler.name                                 <i class="conum" data-value="3"></i><b>(3)</b>
    map '/four', GET, POST to SampleHandler
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can specify the name of the handler by class name with optional method name after double colon <code>::</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can specify the handler by class reference</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can specify which HTTP methods are be handled for given URL</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also test handlers which do not uses the proxy integration</p>
</div>
<div class="listingblock">
<div class="title">API Gateway Lambda Configuration (without Proxy)</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">Gru gru = Gru.create(ApiGatewayProxy.create {
    map '/five/{action}/{id}' to NonProxyHandler, {                         <i class="conum" data-value="1"></i><b>(1)</b>
        pathParameters('action', 'id')                                      <i class="conum" data-value="2"></i><b>(2)</b>
        queryStringParameters 'foo', 'bar'                                  <i class="conum" data-value="3"></i><b>(3)</b>
        response(200) {                                                     <i class="conum" data-value="4"></i><b>(4)</b>
            headers 'Content-Type': 'application/json'                      <i class="conum" data-value="5"></i><b>(5)</b>
        }
    }
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The main difference is that you specify the request and response mapping</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can specify which path parameters are being extracted into the function input object</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can specify which query parameters are being extracted into the function input object</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can specify the response mapping with given status</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can specify the headers mapping for the response</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extending_gru"><a class="anchor" href="#_extending_gru"></a>7. Extending Gru</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_extending_dsl"><a class="anchor" href="#_extending_dsl"></a>7.1. Extending DSL</h3>
<div class="paragraph">
<p>Gru DSL can be easily extend. Gru uses minions whenever it is possible. <code>Minion</code> interface
requires several methods to be implemented to intercept the test flow.</p>
</div>
<div class="listingblock">
<div class="title">Minion</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">/**
 * @return index of the minion to, so they handle the test in given order
 */
int getIndex();

/**
 * Prepares the execution of controller action.
 * @param client controller unit test
 * @param squad minion's colleagues
 * @param context context of execution, in this phase you should only add errors if some conditions are not met
 * @return new context holding any exception which happens during the preparation or the initial context from parameter
 */
GruContext beforeRun(Client client, Squad squad, GruContext context);

/**
 * Modifies the result of the execution of controller action.
 *
 * Minions handle the result in reversed order.
 *
 * @param client controller unit test
 * @param squad minion's colleagues
 * @param context context of execution, in this phase can modify the result or add exception
 * @return modified context or the initial one from the parameter
 */
GruContext afterRun(Client client, Squad squad, GruContext context);

/**
 * Verifies the response after execution of the controller action.
 *
 * @param client controller unit test
 * @param squad minion's colleagues
 * @param context context of the execution, in this phase you can't modify the context, you can just throw any {@link Throwable} based on the current context state
 * @throws Throwable if any of the conditions are not met
 */
void verify(Client client, Squad squad, GruContext context) throws Throwable;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Client</code> represents the current client such as <code>Http</code> or <code>Grails</code>.</p>
</div>
<div class="paragraph">
<p><code>Squad</code> is group of minions used in current test.</p>
</div>
<div class="paragraph">
<p><code>GruContext</code> is immutable object which holds any error been thrown during the execution phase and also the result of the execution.</p>
</div>
<div class="paragraph">
<p>Grails implementation provides various example of extending the DSL. <code>ModelMinion</code> is responsible for checking the model
returned from the controller.</p>
</div>
<div class="listingblock">
<div class="title">ModelMinion.groovy</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">package com.agorapulse.gru.grails.minions

import com.agorapulse.gru.GruContext
import com.agorapulse.gru.Squad
import com.agorapulse.gru.grails.Grails
import com.agorapulse.gru.minions.AbstractMinion
import org.springframework.web.servlet.ModelAndView

/**
 * Minion responsible for verifying model returned from the controller action.
 */
class ModelMinion extends AbstractMinion&lt;Grails&gt; {                                      <i class="conum" data-value="1"></i><b>(1)</b>

    final int index = MODEL_MINION_INDEX                                                <i class="conum" data-value="2"></i><b>(2)</b>

    Object model                                                                        <i class="conum" data-value="3"></i><b>(3)</b>

    ModelMinion() {
        super(Grails)                                                                   <i class="conum" data-value="4"></i><b>(4)</b>
    }

    @Override
    @SuppressWarnings('Instanceof')
    void doVerify(Grails grails, Squad squad, GruContext context) throws Throwable {    <i class="conum" data-value="5"></i><b>(5)</b>
        if (model instanceof Map &amp;&amp; context.result instanceof Map) {
            model.each { key, value -&gt;
                assert context.result[key] == value
            }
        } else if (model instanceof ModelAndView) {
            assert context.result

            ModelAndView result = context.result as ModelAndView

            assert result.model == model.model
            assert result.view == model.view
            assert result.status == model.status
        } else if (model != null) {
            assert context.result == model
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>AbstractMinion</code> guarantees type safety and allows to implements just some of the methods of the interface</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>beforeRun</code> and <code>verify</code> methods are executed sorted by ascending order by the <code>index</code>, <code>afterRun</code> in descending order</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Internal state of the minion, at most one instance of the minion exists per test</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Type token to ensure type safety</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Type-safe method to verify the result of the execution</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Engaging Minion</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify model with engage'() {
    given:
        def moon = [name: 'Moon', planet: 'Earth']
        MoonService moonService = Mock(MoonService)
        controller.moonService = moonService
    when:
        gru.engage(new ModelMinion(model: [moon: moon])).test {
            get '/moons/earth/moon/info'
        }
    then:
        gru.verify()
        1 * moonService.findByPlanetAndName('earth', 'moon') &gt;&gt; moon
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although it is possible to use use <code>engage</code> method to add new minion, it is more convenient to enhance the DSL with new
method. As our minion is enhancing the request definition, we simply add new extension method to <code>RequestDefinitionBuilder</code> object:</p>
</div>
<div class="listingblock">
<div class="title">Extension Class</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">/**
 * Add convenient methods for Grails to test definition DSL.
 */
@CompileDynamic
class GrailsGruExtensions {

    // ...

    /**
     * Sets the expected model returned from the controller action.
     *
     * @param aModel expected model
     * @return self
     */
    static ResponseDefinitionBuilder model(ResponseDefinitionBuilder self, Object aModel) { <i class="conum" data-value="1"></i><b>(1)</b>
        self.command(ModelMinion) {                                                         <i class="conum" data-value="2"></i><b>(2)</b>
            model = aModel
        }
    }

    // ...

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>New extension method <code>model</code> will be added to <code>ResponseDefinitionBuilder</code> class</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>command</code> method will add new minion to the squad if not already present and it allows to do additional configuration such as storing the model&#8217;s value, there is its counterpart <code>ask</code> if you want to get information from another minion from the squad</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You have to create extensions class descriptor in order to make the extension methods available in the code:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/services/org.codehaus.groovy.runtime.ExtensionModule</div>
<div class="content">
<pre>moduleName = gru-grails
moduleVersion = @VERSION@
extensionClasses = com.agorapulse.gru.grails.GrailsGruExtensions</pre>
</div>
</div>
<div class="paragraph">
<p>After that the new extension method can be used in any test</p>
</div>
<div class="listingblock">
<div class="title">Using Method from Extension</div>
<div class="content">
<pre class="prettyprint highlight"><code data-lang="groovy">void 'verify model'() {
    given:
        def moon = [name: 'Moon', planet: 'Earth']
        MoonService moonService = Mock(MoonService)
        controller.moonService = moonService
    when:
        gru.test {
            get '/moons/earth/moon/info'
            expect {
                model moon: moon
            }
        }
    then:
        gru.verify()
        1 * moonService.findByPlanetAndName('earth', 'moon') &gt;&gt; moon
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_new_client"><a class="anchor" href="#_creating_new_client"></a>7.2. Creating New Client</h3>
<div class="paragraph">
<p>Creating new client is bit more work but you can check <code>Http</code> client which is rather small implementation.
The core idea is to provide methods to update request and to check the response returned.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_release_notes"><a class="anchor" href="#_release_notes"></a>8. Release Notes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_2_0_0"><a class="anchor" href="#_2_0_0"></a>8.1. 2.0.0</h3>
<div class="sect3">
<h4 id="_breaking_changes"><a class="anchor" href="#_breaking_changes"></a>8.1.1. Breaking Changes</h4>
<div class="ulist">
<ul>
<li>
<p>The minimal Java version has been set to Java 11</p>
</li>
<li>
<p>The Micronaut module has been upgraded to Micronaut 4.x, Groovy 4.x and Java 17</p>
</li>
<li>
<p>The HTTP module has been removed as the <code>Http</code> client is now part of the core <code>gru</code> package</p>
</li>
<li>
<p>The original HTTP module has been renamed to <code>gru-okhttp</code> and the client accordingly to <code>OkHttp</code></p>
</li>
<li>
<p>The libraries required to evaluate HTML responses has been moved to compile only dependencies</p>
</li>
<li>
<p>Micronaut module now uses <code>micronaut-http-client</code> instead of the default HTTP one</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_new_features"><a class="anchor" href="#_new_features"></a>8.1.2. New Features</h4>
<div class="ulist">
<ul>
<li>
<p>New JDK based <code>Http</code> client</p>
</li>
<li>
<p>New Microaut HTTP Client based  client</p>
</li>
<li>
<p>Small improvements in the Kotlin DSL</p>
</li>
<li>
<p>No need to specify the reference class when calling <code>Gru.create()</code> or <code>Http.create()</code>. The class is automatically detected using the stack walker API.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.0.2<br>
Last updated 2023-12-05 10:01:13 UTC
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/run_prettify.min.js"></script>
</body>
</html>